webpackJsonp([4],{QjOv:function(e,t){},"R/sY":function(e,t){},"ge/Z":function(e,t){},zfg2:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i("Xxa5"),a=i.n(s),n=i("exGp"),o=i.n(n),r=i("Dd8w"),l=i.n(r),c=i("PJh5"),u=i.n(c),g=i("NYxO"),m={name:"ImDialog",props:{active:Boolean,push:Number,online:Boolean,me:Boolean,info:Object},computed:{statusText:function(){return this.online?this.$t("online"):this.$t("was")+u()(this.info.recipient_id.last_online_time).fromNow()}},i18n:{messages:{en:{online:"Online",was:"was online "},ru:{online:"Онлайн",was:"был в сети "}}}},d={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"im-dialog",class:{active:e.active,push:e.push}},[s("router-link",{staticClass:"im-dailog__pic",attrs:{to:{name:"ProfileId",params:{id:e.info.recipient_id.id}}}},[e.info.recipient_id.photo?s("img",{attrs:{src:e.info.recipient_id.photo,alt:e.info.recipient_id.first_name}}):s("img",{attrs:{src:i("H+Ck"),alt:e.info.recipient_id.first_name}})]),s("div",{staticClass:"im-dialog__info"},[s("router-link",{staticClass:"im-dialog__name",attrs:{to:{name:"ProfileId",params:{id:e.info.recipient_id.id}}}},[e._v(e._s(e.info.recipient_id.first_name+" "+e.info.recipient_id.last_name))]),s("span",{staticClass:"user-status",class:{online:e.online}},[e._v(e._s(e.statusText))])],1),s("div",{staticClass:"im-dialog__content"},[s("p",{staticClass:"im-dialog__last"},[e.me&&e.info.last_message?s("span",{staticClass:"im-dialog__last-me"},[e._v("Вы:")]):e._e(),e._v(e._s(e.info.last_message.message_text))]),e.me&&e.info.last_message?s("span",{staticClass:"im-dialog__time"},[e._v(e._s(e._f("moment")(e.info.last_message.time-10800,"from")))]):e._e()]),e.push>0?s("span",{staticClass:"im-dialog__push"},[e._v(e._s(e.push))]):e._e()],1)},staticRenderFns:[]};var f=i("VU/8")(m,d,!1,function(e){i("R/sY")},null,null).exports,h=i("Duis"),p=i("A7yg"),_=i.n(p),v=i("vl5P"),D={name:"ImChat",props:{info:Object,messages:Array,online:Boolean},components:{VirtualList:_.a},data:function(){return{mes:"",itemComponent:h.a,isUserViewHistory:!1,fetching:!1,offset:0,itemPrePage:10}},mounted:function(){this.follow=!0,this.setVirtualListToBottom()},watch:{messages:function(){this.follow&&this.setVirtualListToBottom()}},computed:l()({},Object(g.c)("profile/dialogs",["getTotalMessage","getActiveDialogId","getTypeMessage","getMessages"]),Object(g.c)("profile/info",["getInfo"]),{statusText:function(){return this.online?this.$t("online"):this.$t("was")+u()(this.info.recipient_id.last_online_time).fromNow()},messagesGrouped:function(){var e=[],t=null;return this.messages.forEach(function(i){var s=u()(i.time).format("YYYY-MM-DD");s!==t&&(t=s,e.push(function(e){return{sid:"group-"+e,stubDate:!0,date:e}}(t))),e.push(i)}),e},checkTypingMessage:function(){var e=this,t=void 0;return this.getTypeMessage.forEach(function(i){i.dialog==e.getActiveDialogId&&(t=i.author)}),t}}),methods:l()({},Object(g.b)("profile/dialogs",["postMessage","loadOlderMessages"]),Object(g.c)("profile/dialogs",["isHistoryEndReached"]),Object(g.d)("profile/dialogs",["setUnreadedDialogs"]),{onSubmitMessage:function(){""!=this.mes&&(this.postMessage({id:this.info.id,message_text:this.mes}),this.mes="",this.finishedTypingMessage())},onScrollToTop:function(){var e=this;return o()(a.a.mark(function t(){return a.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.$refs.vsl){t.next=8;break}if(!(e.messages.length<e.messages[0].total)){t.next=8;break}return e.messagesGrouped[0],e.fetching=!0,t.next=6,e.loadOlderMessages({itemPerPage:e.itemPrePage,offset:e.offset+e.itemPrePage}).then(function(){e.offset+=e.itemPrePage});case 6:e.setVirtualListToOffset(1),e.$nextTick(function(){var t=e.$refs.vsl.getScrollSize()/e.offset;e.setVirtualListToOffset(t*e.itemPrePage),e.fetching=!1});case 8:case"end":return t.stop()}},t,e)}))()},onScroll:function(){this.follow=!1},onScrollToBottom:function(){this.follow=!0},setVirtualListToOffset:function(e){this.$refs.vsl&&this.$refs.vsl.scrollToOffset(e)},setVirtualListToBottom:function(){this.$refs.vsl&&this.$refs.vsl.scrollToBottom()},typingMessage:function(){if(this.mes){var e={author:this.getInfo.id,dialog:this.getActiveDialogId};Object(v.j)(e)}},finishedTypingMessage:function(){var e={author:Number(this.getInfo.id),dialog:Number(this.getActiveDialogId)};Object(v.i)(e)},resetCounterUnreadedDialogs:function(){var e={id:this.getActiveDialogId,unread_count:0};this.setUnreadedDialogs(e)}}),i18n:{messages:{en:{nomore:"No more messages",placeholder:"Your message...",online:"Online",was:"was online "},ru:{nomore:"Больше сообщений нет",placeholder:"Ваше сообщение...",online:"Онлайн",was:"был в сети "}}}},y={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"im-chat",on:{click:e.resetCounterUnreadedDialogs}},[s("div",{staticClass:"im-chat__user"},[s("router-link",{staticClass:"im-chat__user-pic",attrs:{to:{name:"ProfileId",params:{id:e.info.recipient_id.id}}}},[e.info.recipient_id.photo?s("img",{attrs:{src:e.info.recipient_id.photo,alt:e.info.recipient_id.first_name}}):s("img",{attrs:{src:i("H+Ck"),alt:e.info.recipient_id.first_name}})]),s("router-link",{staticClass:"im-chat__user-name",attrs:{to:{name:"ProfileId",params:{id:e.info.recipient_id.id}}}},[e._v(e._s(e.info.recipient_id.first_name+" "+e.info.recipient_id.last_name))]),e.checkTypingMessage?s("div",{staticClass:"typing"},[e._m(0),s("p",{staticClass:"typing__text"},[e._v(e._s(e.checkTypingMessage)+" набирает сообщение")])]):e._e(),s("span",{staticClass:"user-status",class:{online:e.online}},[e._v(e._s(e.statusText))])],1),e.messages?s("div",{staticClass:"im-chat__infitite_list_wrapper"},[s("virtual-list",{ref:"vsl",staticClass:"im-chat__infitite_list scroll-touch",attrs:{size:60,keeps:120,"data-key":"sid","data-sources":e.messagesGrouped,"data-component":e.itemComponent,"wrap-class":"im-chat__message","root-tag":"section"},on:{totop:e.onScrollToTop,"&scroll":function(t){return e.onScroll(t)},tobottom:e.onScrollToBottom}},[s("div",{directives:[{name:"show",rawName:"v-show",value:e.fetching,expression:"fetching"}],staticClass:"im-chat__loader",attrs:{slot:"header"},slot:"header"},[s("div",{directives:[{name:"show",rawName:"v-show",value:!e.isHistoryEndReached(),expression:"!isHistoryEndReached()"}],staticClass:"spinner"}),s("div",{directives:[{name:"show",rawName:"v-show",value:e.isHistoryEndReached(),expression:"isHistoryEndReached()"}],staticClass:"finished"},[e._v(e._s(e.$t("nomore")))])])])],1):e._e(),s("form",{staticClass:"im-chat__enter",attrs:{action:"#"},on:{submit:function(t){return t.preventDefault(),e.onSubmitMessage(t)}}},[s("input",{directives:[{name:"model",rawName:"v-model",value:e.mes,expression:"mes"}],staticClass:"im-chat__enter-input",attrs:{type:"text",placeholder:e.$t("placeholder")},domProps:{value:e.mes},on:{input:[function(t){t.target.composing||(e.mes=t.target.value)},e.typingMessage],blur:e.finishedTypingMessage}})])])},staticRenderFns:[function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"typing__animations-block"},[t("div",{staticClass:"typing__animations-item"}),t("div",{staticClass:"typing__animations-item"}),t("div",{staticClass:"typing__animations-item"})])}]};var C={name:"Im",components:{ImDialog:f,ImChat:i("VU/8")(D,y,!1,function(e){i("ge/Z")},null,null).exports,isLoading:i("vjHR").a},data:function(){return{intervalForMessages:null,isLoad:!1}},computed:l()({},Object(g.c)("profile/dialogs",["getMessages","getActiveDialog","getDialogs","getActiveDialogId"]),{messages:function(){var e=Number(this.getActiveDialogId);return this.getMessages[e]?this.getMessages[e]:[]}}),methods:l()({},Object(g.b)("profile/dialogs",["loadFreshMessages","switchDialog","closeDialog","createDialogWithUser","apiLoadAllDialogs"]),{countPush:function(e){return e>0?e:null},checkOnlineUser:function(e){return u()().diff(u()(e),"seconds")<=60},clickOnDialog:function(e){this.$router.push({name:"Im",query:{getActiveDialog:e}})},selectDialogByRoute:function(e,t){var i=this;return o()(a.a.mark(function s(){var n;return a.a.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(!e.query.getActiveDialog){s.next=4;break}t.switchDialog(e.query.getActiveDialog),s.next=16;break;case 4:if(!e.query.userId){s.next=8;break}t.createDialogWithUser(e.query.userId),s.next=16;break;case 8:if(!(t.getDialogs.length>0)){s.next=12;break}i.getActiveDialogId?(n=i.getActiveDialogId,t.$router.push({name:"Im",query:{getActiveDialog:n}})):t.$router.push({name:"Im",query:{getActiveDialog:t.getDialogs[0].id}}),s.next=16;break;case 12:return s.next=14,t.apiLoadAllDialogs().then(function(e){i.offset=e});case 14:t.getDialogs.length>0&&t.$router.push({name:"Im",query:{getActiveDialog:t.getDialogs[0].id}}),console.log("No dialogs at all");case 16:case"end":return s.stop()}},s,i)}))()}}),beforeRouteEnter:function(e,t,i){var s,n=this;i((s=o()(a.a.mark(function t(i){return a.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:i.selectDialogByRoute(e,i);case 1:case"end":return t.stop()}},t,n)})),function(e){return s.apply(this,arguments)}))},beforeRouteUpdate:function(e,t,i){this.selectDialogByRoute(e,this),i()},beforeDestroy:function(){this.closeDialog()}},w={render:function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"im"},[i("div",{staticClass:"im__dialogs"},e._l(e.getDialogs,function(t){return i("im-dialog",{key:t.id,attrs:{info:t,push:e.countPush(t.unread_count),me:t.sendByMe,active:e.getActiveDialog&&t.id===e.getActiveDialog.id,online:e.checkOnlineUser(t.recipient_id.last_online_time)},nativeOn:{click:function(i){return e.clickOnDialog(t.id)}}})}),1),e.getActiveDialog&&e.messages?i("div",{staticClass:"im__chat"},[i("im-chat",{attrs:{info:e.getActiveDialog,messages:e.messages,online:e.checkOnlineUser(e.getActiveDialog.recipient_id.last_online_time)}})],1):e._e()])},staticRenderFns:[]};var b=i("VU/8")(C,w,!1,function(e){i("QjOv")},null,null);t.default=b.exports}});
//# sourceMappingURL=4.6492da5bb75a502f143e.js.map